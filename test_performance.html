<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHIR Viewer Performance Test</title>
    <script src="./js/storage.js"></script>
</head>
<body>
    <h1>FHIR Viewer Performance Test</h1>
    <div id="results"></div>
    
    <script>
        async function runPerformanceTest() {
            const results = document.getElementById('results');
            results.innerHTML = '<p>Running performance tests...</p>';
            
            try {
                const storage = new FHIRStorage();
                const startTime = performance.now();
                
                // Test 1: Initialize storage system
                console.log('Test 1: Initializing storage...');
                await storage.initialize();
                const initTime = performance.now() - startTime;
                
                // Test 2: Load resource lists
                console.log('Test 2: Loading resource lists...');
                const fhirStart = performance.now();
                const fhirResources = await storage.getResourceList('fhir-r4');
                const fhirListTime = performance.now() - fhirStart;
                
                const usCoreStart = performance.now();
                const usCoreResources = await storage.getResourceList('us-core-stu6.1');
                const usCoreListTime = performance.now() - usCoreStart;
                
                // Test 3: Load specific resources
                console.log('Test 3: Loading specific resources...');
                const patientStart = performance.now();
                const patient = await storage.getResource('Patient', 'fhir-r4');
                const patientLoadTime = performance.now() - patientStart;
                
                const usCorePatientStart = performance.now();
                const usCorePatient = await storage.getResource('USCorePatient', 'us-core-stu6.1');
                const usCorePatientLoadTime = performance.now() - usCorePatientStart;
                
                // Test 4: Search functionality
                console.log('Test 4: Testing search...');
                const searchStart = performance.now();
                const searchResults = await storage.searchResources('patient');
                const searchTime = performance.now() - searchStart;
                
                // Display results
                results.innerHTML = `
                    <h2>Performance Test Results</h2>
                    <div style="font-family: monospace; background: #f5f5f5; padding: 20px;">
                        <p><strong>✅ Storage Initialization:</strong> ${initTime.toFixed(2)}ms</p>
                        <p><strong>✅ FHIR Resource List (${fhirResources.length} resources):</strong> ${fhirListTime.toFixed(2)}ms</p>
                        <p><strong>✅ US Core Resource List (${usCoreResources.length} profiles):</strong> ${usCoreListTime.toFixed(2)}ms</p>
                        <p><strong>✅ Patient Resource Load (${patient.elements?.length || 0} elements):</strong> ${patientLoadTime.toFixed(2)}ms</p>
                        <p><strong>✅ US Core Patient Load (${usCorePatient.elements?.length || 0} elements):</strong> ${usCorePatientLoadTime.toFixed(2)}ms</p>
                        <p><strong>✅ Search "patient" (${searchResults.length} results):</strong> ${searchTime.toFixed(2)}ms</p>
                        
                        <h3>Data Verification</h3>
                        <p><strong>Total FHIR R4 Resources:</strong> ${fhirResources.length}</p>
                        <p><strong>Total US Core Profiles:</strong> ${usCoreResources.length}</p>
                        <p><strong>Patient Resource Elements:</strong> ${patient.elements?.length || 0}</p>
                        <p><strong>US Core Patient Elements:</strong> ${usCorePatient.elements?.length || 0}</p>
                        
                        <h3>Cache Statistics</h3>
                        <p><strong>Cache Hit Rate:</strong> ${(storage.getCacheStats().hitRate * 100).toFixed(1)}%</p>
                        <p><strong>Avg Load Time:</strong> ${(storage.getCacheStats().avgLoadTime || 0).toFixed(2)}ms</p>
                        
                        <h3>Sample Resources Found</h3>
                        <p><strong>FHIR R4:</strong> ${fhirResources.slice(0, 5).join(', ')}...</p>
                        <p><strong>US Core:</strong> ${usCoreResources.slice(0, 5).join(', ')}...</p>
                    </div>
                `;
                
                console.log('✅ All performance tests passed!');
                
            } catch (error) {
                results.innerHTML = `
                    <h2>❌ Performance Test Failed</h2>
                    <p style="color: red; font-family: monospace; background: #ffe6e6; padding: 10px;">
                        Error: ${error.message}
                    </p>
                    <pre style="background: #f0f0f0; padding: 10px; overflow: auto;">
                        ${error.stack}
                    </pre>
                `;
                console.error('Performance test failed:', error);
            }
        }
        
        // Run test when page loads
        document.addEventListener('DOMContentLoaded', runPerformanceTest);
    </script>
</body>
</html>